# Plan: project-metadata-builder Skill

## Summary

Create a new skill `project-metadata-builder` that generates and maintains a comprehensive `${CLAUDE_PROJECTS_YML_PATH}` registry. The skill will be invoked by `project-discovery-agent` and can run automatically, manually, or periodically.

## New Files to Create

| File | Purpose |
|------|---------|
| `${CLAUDE_CONFIG_YML_PATH}` | Global configuration for custom features |
| `${CLAUDE_PROJECTS_YML_PATH}` | Project metadata registry (generated) |
| `${CLAUDE_SKILLS_PATH}/project-metadata-builder/SKILL.md` | Skill definition |
| `${CLAUDE_SKILLS_PATH}/project-metadata-builder/pyproject.toml` | Python dependencies |
| `${CLAUDE_SKILLS_PATH}/project-metadata-builder/scripts/builder.py` | Main metadata builder |
| `${CLAUDE_SKILLS_PATH}/project-metadata-builder/scripts/schema.py` | YAML schema definitions |
| `${CLAUDE_SKILLS_PATH}/project-metadata-builder/scripts/collectors/` | Metadata collection modules |

## Files to Modify

| File | Changes |
|------|---------|
| `${CLAUDE_AGENTS_PATH}/project-disovery-agent.md` | Add skill invocation after analysis |

## TODO List

- [ ] Create `${CLAUDE_CONFIG_YML_PATH}` with default settings
- [ ] Create skill directory structure
- [ ] Create `pyproject.toml` with dependencies (pyyaml, loguru, gitpython)
- [ ] Create `schema.py` with dataclasses for project metadata
- [ ] Create collector modules (git, languages, frameworks, docker, mcp)
- [ ] Create `builder.py` main orchestrator
- [ ] Create `SKILL.md` with activation triggers and instructions
- [ ] Update `project-disovery-agent.md` to invoke skill
- [ ] Test skill with current project
- [ ] Verify `projects.yml` generation

---

## Schema Design

### ${CLAUDE_CONFIG_YML_PATH}

```yaml
# Global configuration for Claude Code custom features
project_metadata:
  # Session history settings
  session_history_limit: 10          # Keep last N sessions per project

  # Auto-update settings
  auto_update_on_session: true       # Update on session start
  periodic_refresh_hours: 24         # Periodic refresh interval (0 = disabled)

  # Threshold settings
  stale_project_days: 30             # Mark project stale after N days inactive
  activity_threshold_commits: 5      # Minimum commits for "active" status

  # Paths
  projects_file: ${CLAUDE_PROJECTS_YML_PATH}

  # Logging
  log_level: INFO
```

### ${CLAUDE_PROJECTS_YML_PATH}

```yaml
# Auto-generated by project-metadata-builder skill
# Last updated: 2025-12-11T15:30:00Z

projects:
  /workspace/projects/personal/claude-sandbox:
    # Identity
    name: claude-sandbox
    slug: claude-sandbox
    description: "Docker-ized development environment for Claude Code CLI"

    # Git metadata
    git:
      remote_url: git@github.com:brianclaridge/claude-sandbox.git
      branch: main
      last_commit:
        hash: abc123def
        message: "feat: add project-metadata-builder skill"
        author: Brian Claridge
        date: 2025-12-11T15:00:00Z
      total_commits: 42

    # Technical profile
    languages:
      primary: Python
      all:
        - Python: 45%
        - Shell: 30%
        - Markdown: 15%
        - YAML: 10%

    frameworks:
      - playwright
      - structlog
      - docker

    dependencies:
      python:
        - playwright>=1.40.0
        - loguru>=0.7.0
        - structlog>=24.0.0
      node:
        - "@anthropic-ai/claude-code"
        - playwright

    # Structure
    structure:
      type: monorepo
      key_directories:
        - agents/
        - skills/
        - hooks/
        - directives/
        - docker/
      entry_points:
        - docker-compose.yml
        - Taskfile.yml

    # Runtime configuration
    runtime:
      docker:
        compose_file: docker-compose.yml
        services:
          - claude
      mcp_servers:
        - context7
        - playwright

    # Activity tracking
    activity:
      status: active  # active | stale | archived
      first_seen: 2025-12-01T10:00:00Z
      last_updated: 2025-12-11T15:30:00Z

    # Session history (last N)
    sessions:
      - id: session_abc123
        started: 2025-12-11T14:00:00Z
        ended: 2025-12-11T15:30:00Z
        commits: 3
        files_changed: 12
      - id: session_xyz789
        started: 2025-12-10T09:00:00Z
        ended: 2025-12-10T12:00:00Z
        commits: 5
        files_changed: 8
```

---

## Implementation Details

### Directory Structure

```
${CLAUDE_SKILLS_PATH}/project-metadata-builder/
├── SKILL.md                    # Skill definition
├── pyproject.toml              # Dependencies
└── scripts/
    ├── __init__.py
    ├── builder.py              # Main orchestrator
    ├── schema.py               # Dataclass definitions
    ├── config.py               # Config loading/defaults
    ├── collectors/
    │   ├── __init__.py
    │   ├── git_collector.py    # Git metadata
    │   ├── lang_collector.py   # Language detection
    │   ├── deps_collector.py   # Dependency parsing
    │   ├── docker_collector.py # Docker config
    │   └── mcp_collector.py    # MCP server detection
    └── utils/
        ├── __init__.py
        └── yaml_utils.py       # YAML read/write helpers
```

### SKILL.md Activation Triggers

```yaml
---
name: project-metadata-builder
description: Build and update project metadata registry in ${CLAUDE_PROJECTS_YML_PATH}. Use when starting a session, after project analysis, or when user says "update project metadata", "refresh projects", "register project".
allowed-tools: Read, Write, Bash, Glob, Grep
---
```

### Python Dependencies (pyproject.toml)

```toml
[project]
name = "project-metadata-builder"
version = "0.1.0"
description = "Build comprehensive project metadata for Claude Code"
requires-python = ">=3.11"
dependencies = [
    "pyyaml>=6.0",
    "loguru>=0.7.0",
    "gitpython>=3.1.0",
]

[dependency-groups]
dev = []
```

### Collector Modules

| Module | Extracts |
|--------|----------|
| `git_collector.py` | Remote URL, branch, commits, last commit details |
| `lang_collector.py` | Primary language, language percentages |
| `deps_collector.py` | Python (pyproject.toml, requirements.txt), Node (package.json) |
| `docker_collector.py` | Compose file, services, volumes |
| `mcp_collector.py` | MCP servers from .mcp.json or settings.json |

### Integration with project-discovery-agent

Add to agent's workflow:
```markdown
## Post-Analysis

After generating the functional report:
1. Invoke `project-metadata-builder` skill to update registry
2. Pass project path context to skill
```

---

## Execution Flow

```text
Session Start
    │
    ▼
project-discovery-agent runs
    │
    ▼
Agent completes analysis
    │
    ▼
Invokes project-metadata-builder skill
    │
    ▼
Skill reads ${CLAUDE_CONFIG_YML_PATH}
    │
    ▼
Collectors gather metadata
    │
    ▼
Merge with existing projects.yml
    │
    ▼
Update session history
    │
    ▼
Write updated projects.yml
    │
    ▼
Return success to agent
```

---

## Testing Plan

1. **Unit Tests**: Each collector module
2. **Integration Test**: Full metadata build for current project
3. **Merge Test**: Add new project to existing registry
4. **Session History Test**: Verify history rotation (keep last N)

---

## Future Dashboard Integration

The `projects.yml` format is designed to support:

- Project listing with status indicators
- Activity timeline visualization
- Language/framework breakdown charts
- Session history viewer
- Git activity graphs

Dashboard application would read `${CLAUDE_PROJECTS_YML_PATH}` directly.
